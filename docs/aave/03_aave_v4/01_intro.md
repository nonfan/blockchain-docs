# Aave V4 åè®®æ¦‚è¿°

## V4 ç®€ä»‹

Aave V4 æ˜¯åè®®çš„ä¸‹ä¸€ä»£ç‰ˆæœ¬ï¼Œå¼•å…¥äº†é©å‘½æ€§çš„æ¶æ„æ”¹è¿›ï¼Œé¢„è®¡ 2024 å¹´ä¸»ç½‘ä¸Šçº¿ã€‚V4 çš„æ ¸å¿ƒç›®æ ‡æ˜¯æå‡èµ„æœ¬æ•ˆç‡ã€å¢å¼ºå¯æ‰©å±•æ€§å’Œæ”¹å–„ç”¨æˆ·ä½“éªŒã€‚

## æ ¸å¿ƒåˆ›æ–°

### 1. ç»Ÿä¸€æµåŠ¨æ€§å±‚ (Unified Liquidity Layer)

V4 æœ€é‡è¦çš„åˆ›æ–°æ˜¯ç»Ÿä¸€æµåŠ¨æ€§å±‚ï¼Œå®ƒå°†æ‰€æœ‰å¸‚åœºçš„æµåŠ¨æ€§æ•´åˆåˆ°ä¸€ä¸ªå…±äº«å±‚ä¸­ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç»Ÿä¸€æµåŠ¨æ€§å±‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ å¸‚åœº A  â”‚  â”‚ å¸‚åœº B  â”‚  â”‚ å¸‚åœº C  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚
â”‚       â”‚            â”‚            â”‚               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                    â†“                            â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚           â”‚   å…±äº«æµåŠ¨æ€§   â”‚                     â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿**ï¼š
- æ›´é«˜çš„èµ„æœ¬æ•ˆç‡
- å‡å°‘æµåŠ¨æ€§ç¢ç‰‡åŒ–
- åŠ¨æ€é£é™©ç®¡ç†
- è·¨å¸‚åœºä¼˜åŒ–

### 2. æ¨¡å—åŒ–æ¶æ„

V4 é‡‡ç”¨å®Œå…¨æ¨¡å—åŒ–çš„è®¾è®¡ï¼Œå…è®¸ç‹¬ç«‹å‡çº§å„ä¸ªç»„ä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ ¸å¿ƒåè®®                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ å€Ÿè´·æ¨¡å— â”‚ â”‚ æ¸…ç®—æ¨¡å— â”‚ â”‚ é—ªç”µè´·æ¨¡å—â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ åˆ©ç‡æ¨¡å— â”‚ â”‚ é¢„è¨€æœºæ¨¡å—â”‚ â”‚ æ²»ç†æ¨¡å— â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 æ‰©å±•æ¨¡å—                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ è‡ªåŠ¨åŒ–   â”‚ â”‚ è·¨é“¾æ¡¥æ¥ â”‚ â”‚ ç¬¬ä¸‰æ–¹   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æ™ºèƒ½è´¦æˆ·ç³»ç»Ÿ

åŸç”Ÿæ”¯æŒ ERC-4337 è´¦æˆ·æŠ½è±¡ï¼š

- **æ‰¹é‡æ“ä½œ**ï¼šå•ç¬”äº¤æ˜“æ‰§è¡Œå¤šä¸ªæ“ä½œ
- **Gas æŠ½è±¡**ï¼šæ”¯æŒä»£ä»˜ Gas
- **ç¤¾äº¤æ¢å¤**ï¼šè´¦æˆ·æ¢å¤æœºåˆ¶
- **è‡ªåŠ¨åŒ–æ‰§è¡Œ**ï¼šæ¡ä»¶è§¦å‘çš„è‡ªåŠ¨æ“ä½œ

### 4. åŠ¨æ€é£é™©å‚æ•°

é£é™©å‚æ•°å¯ä»¥æ ¹æ®å¸‚åœºæ¡ä»¶å®æ—¶è°ƒæ•´ï¼š

```solidity
interface IDynamicRiskManager {
    struct RiskConfig {
        uint256 baseLTV;
        uint256 maxLTV;
        uint256 liquidationThreshold;
        uint256 volatilityFactor;
    }
    
    function getCurrentRiskParams(address asset) 
        external view returns (RiskConfig memory);
    
    function updateRiskParams(address asset) external;
}
```

## V3 vs V4 å¯¹æ¯”

| ç‰¹æ€§ | V3 | V4 |
|------|----|----|
| æ¶æ„ | å•ä½“ | æ¨¡å—åŒ– |
| æµåŠ¨æ€§ | ç‹¬ç«‹å¸‚åœº | ç»Ÿä¸€æµåŠ¨æ€§å±‚ |
| å‡çº§æ€§ | æœ‰é™ | å®Œå…¨æ¨¡å—åŒ– |
| è´¦æˆ·ç³»ç»Ÿ | EOA | åŸç”Ÿè´¦æˆ·æŠ½è±¡ |
| é£é™©å‚æ•° | é™æ€ | åŠ¨æ€è°ƒæ•´ |
| Gas æ•ˆç‡ | æ ‡å‡† | æ˜¾è‘—ä¼˜åŒ– |
| è‡ªåŠ¨åŒ– | åŸºç¡€ | åŸç”Ÿæ”¯æŒ |

## æ–°åŠŸèƒ½ç‰¹æ€§

### è½¯æ¸…ç®— (Soft Liquidation)

V4 å¼•å…¥è½¯æ¸…ç®—æœºåˆ¶ï¼Œåœ¨å¥åº·å› å­æ¥è¿‘ 1 æ—¶é€æ­¥å‡å°‘ä»“ä½ï¼š

```
å¥åº·å› å­ 1.2 â†’ å¼€å§‹è½¯æ¸…ç®—
å¥åº·å› å­ 1.1 â†’ åŠ é€Ÿè½¯æ¸…ç®—
å¥åº·å› å­ 1.0 â†’ ä¼ ç»Ÿæ¸…ç®—
```

**ä¼˜åŠ¿**ï¼š
- å‡å°‘ç”¨æˆ·æŸå¤±
- é™ä½æ¸…ç®—æƒ©ç½š
- æ›´å¹³æ»‘çš„å»æ æ†è¿‡ç¨‹

### å¯å˜æ¸…ç®—æƒ©ç½š

æ¸…ç®—æƒ©ç½šæ ¹æ®å¸‚åœºæ¡ä»¶åŠ¨æ€è°ƒæ•´ï¼š

```solidity
function calculateLiquidationBonus(
    address asset,
    uint256 healthFactor,
    uint256 marketVolatility
) external view returns (uint256) {
    // åŸºç¡€æƒ©ç½š
    uint256 baseBonus = 500; // 5%
    
    // æ ¹æ®å¥åº·å› å­è°ƒæ•´
    if (healthFactor < 0.95e18) {
        baseBonus += 200; // é¢å¤– 2%
    }
    
    // æ ¹æ®å¸‚åœºæ³¢åŠ¨è°ƒæ•´
    if (marketVolatility > HIGH_VOLATILITY) {
        baseBonus += 100; // é¢å¤– 1%
    }
    
    return baseBonus;
}
```

### åŸç”Ÿ GHO é›†æˆ

GHO ç¨³å®šå¸ä¸ V4 æ·±åº¦é›†æˆï¼š

- **ç›´æ¥é“¸é€ **ï¼šæ— éœ€ä¸­é—´æ­¥éª¤
- **åŠ¨æ€åˆ©ç‡**ï¼šåŸºäºå¸‚åœºæ¡ä»¶
- **è·¨é“¾æ”¯æŒ**ï¼šå¤šé“¾ GHO æµåŠ¨æ€§

### é«˜çº§è‡ªåŠ¨åŒ–

```solidity
interface IAutomationModule {
    struct AutomationRule {
        uint256 triggerCondition;
        uint256 targetValue;
        address actionContract;
        bytes actionData;
        bool isActive;
    }
    
    function createRule(AutomationRule calldata rule) external returns (uint256 ruleId);
    function executeRule(uint256 ruleId) external;
    function cancelRule(uint256 ruleId) external;
}
```

**æ”¯æŒçš„è‡ªåŠ¨åŒ–ç±»å‹**ï¼š
- å¥åº·å› å­ä¿æŠ¤
- æ­¢æŸ/æ­¢ç›ˆ
- å®šæœŸå†å¹³è¡¡
- åˆ©ç‡åˆ‡æ¢

## æ€§èƒ½ä¼˜åŒ–

### Gas ä¼˜åŒ–

| æ“ä½œ | V3 Gas | V4 Gas | ä¼˜åŒ–å¹…åº¦ |
|------|--------|--------|----------|
| Supply | 150,000 | 120,000 | -20% |
| Borrow | 200,000 | 160,000 | -20% |
| Repay | 180,000 | 140,000 | -22% |
| Liquidation | 300,000 | 220,000 | -27% |
| Flash Loan | 180,000 | 140,000 | -22% |

### æ‰¹é‡æ“ä½œ

```solidity
interface IBatchOperations {
    struct Operation {
        uint8 operationType; // 0=supply, 1=withdraw, 2=borrow, 3=repay
        address asset;
        uint256 amount;
    }
    
    function executeBatch(Operation[] calldata operations) external;
}

// ä½¿ç”¨ç¤ºä¾‹
Operation[] memory ops = new Operation[](3);
ops[0] = Operation(0, USDC, 1000e6);  // Supply USDC
ops[1] = Operation(0, WETH, 1e18);    // Supply WETH
ops[2] = Operation(2, DAI, 500e18);   // Borrow DAI

batchOperations.executeBatch(ops);
```

## è·¨é“¾åŠŸèƒ½

### Portal å¢å¼º

V4 çš„ Portal åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼š

```solidity
interface ICrossChainPortal {
    function bridgeSupply(
        uint256 destChainId,
        address asset,
        uint256 amount,
        address recipient
    ) external;
    
    function bridgeBorrow(
        uint256 destChainId,
        address asset,
        uint256 amount,
        address recipient
    ) external;
}
```

### è·¨é“¾æµåŠ¨æ€§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ethereum   â”‚ â†â†’  â”‚   Polygon   â”‚ â†â†’  â”‚  Arbitrum   â”‚
â”‚   V4 Pool   â”‚     â”‚   V4 Pool   â”‚     â”‚   V4 Pool   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  ç»Ÿä¸€æµåŠ¨æ€§å±‚    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ²»ç†æ”¹è¿›

### æ¨¡å—åŒ–æ²»ç†

æ¯ä¸ªæ¨¡å—å¯ä»¥æœ‰ç‹¬ç«‹çš„æ²»ç†å‚æ•°ï¼š

```solidity
interface IModuleGovernance {
    function proposeModuleUpdate(
        address module,
        bytes calldata updateData
    ) external returns (uint256 proposalId);
    
    function executeModuleUpdate(uint256 proposalId) external;
}
```

### é£é™©å§”å‘˜ä¼š

ä¸“é—¨çš„é£é™©å§”å‘˜ä¼šå¯ä»¥å¿«é€Ÿå“åº”å¸‚åœºå˜åŒ–ï¼š

- ç´§æ€¥å‚æ•°è°ƒæ•´
- èµ„äº§æš‚åœ/æ¢å¤
- é£é™©ä¸Šé™è°ƒæ•´

## å¼€å‘è€…å·¥å…·

### V4 SDK

```typescript
import { AaveV4 } from '@aave/v4-sdk';

const aave = new AaveV4({
    provider,
    chainId: 1,
});

// æ‰¹é‡æ“ä½œ
await aave.batch([
    aave.supply('USDC', '1000'),
    aave.supply('WETH', '1'),
    aave.borrow('DAI', '500'),
]);

// åˆ›å»ºè‡ªåŠ¨åŒ–è§„åˆ™
await aave.automation.createRule({
    trigger: { type: 'healthFactor', value: 1.2 },
    action: { type: 'repay', asset: 'USDC', amount: '500' },
});
```

### æµ‹è¯•ç½‘

V4 æµ‹è¯•ç½‘å°†åœ¨ä¸»ç½‘ä¸Šçº¿å‰æä¾›ï¼š

- Sepolia æµ‹è¯•ç½‘
- å®Œæ•´åŠŸèƒ½æµ‹è¯•
- æ°´é¾™å¤´æ”¯æŒ

## è¿ç§»è·¯å¾„

### ä» V3 è¿ç§»

1. **è¯„ä¼°ç°æœ‰ä»“ä½**
2. **ä½¿ç”¨è¿ç§»å·¥å…·**
3. **éªŒè¯æ–°ä»“ä½**
4. **å¯ç”¨ V4 åŠŸèƒ½**

```solidity
interface IMigrationHelper {
    function migratePosition(
        address user,
        address[] calldata assets
    ) external;
    
    function estimateMigrationCost(address user) 
        external view returns (uint256);
}
```

## æ—¶é—´çº¿

| é˜¶æ®µ | æ—¶é—´ | å†…å®¹ |
|------|------|------|
| æµ‹è¯•ç½‘ | 2024 Q2 | åŠŸèƒ½æµ‹è¯• |
| å®¡è®¡ | 2024 Q3 | å®‰å…¨å®¡è®¡ |
| ä¸»ç½‘ | 2024 Q4 | æ­£å¼ä¸Šçº¿ |

## ä¸‹ä¸€æ­¥

- ğŸ“– [V4 å¼€å‘æŒ‡å—](./02_development.md) - å­¦ä¹  V4 å¼€å‘
- ğŸ”§ [è¿ç§»æŒ‡å—](./03_migration.md) - ä» V3 è¿ç§»åˆ° V4
